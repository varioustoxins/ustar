name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  grammar-generation:
    name: Generate Grammars
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Generate grammar files using CI script
      run: ./scripts/ci-grammar-generation.sh
    
    - name: Upload grammar artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/star_*.pest

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    needs: grammar-generation
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest] # windows-latest, - removed till bugs fixed  
        rust: [stable] # Use stable Rust
        package: [ustar-parser, ustar-tools]
        features: [default, no-default]

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust ${{ matrix.rust }}
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Download grammar artifacts
      if: matrix.package == 'ustar-parser'
      uses: actions/download-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/
    
    - name: Run test matrix using CI script
      run: |
        ./scripts/ci-test-matrix.sh         \
          --package  ${{ matrix.package }}  \
          --features ${{ matrix.features }} \
          --platform ${{ matrix.os }}
      env:
        RUST_VERSION: ${{ matrix.rust }}

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: grammar-generation
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-clippy-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Download grammar artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/
    
    - name: Run code quality checks using CI script
      run: ./scripts/ci-code-quality.sh

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: grammar-generation
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-integration-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache test data
      uses: actions/cache@v3
      with:
        path: ustar-parser/tests/test_data/
        key: ${{ runner.os }}-test-data-${{ hashFiles('ustar-parser/tests/test_data/**') }}
    
    - name: Download grammar artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/
    
    - name: Install cargo-insta for snapshot testing
      run: cargo install cargo-insta --version 1.34.0
    
    - name: Run integration tests using CI script
      run: ./scripts/ci-integration-tests.sh

  release:
    name: Release to Crates.io
    runs-on: ubuntu-latest
    needs: [test, code-quality, integration-tests]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')) || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        package: [ustar-parser, ustar-tools]
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-release-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Download grammar artifacts
      if: matrix.package == 'ustar-parser'
      uses: actions/download-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/
    
    - name: Verify package can be built for release
      run: cargo package --verbose -p ${{ matrix.package }}
    
    - name: Extract version from package
      id: version
      run: |
        VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "${{ matrix.package }}") | .version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version to release for ${{ matrix.package }}: $VERSION"
    
    - name: Check if version already exists on crates.io
      run: |
        if cargo search ${{ matrix.package }} --limit 1 | grep -q "${{ matrix.package }} = \"${{ steps.version.outputs.version }}\""; then
          echo "Version ${{ steps.version.outputs.version }} already exists on crates.io for ${{ matrix.package }}"
          exit 1
        fi
    
    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }} -p ${{ matrix.package }}
    
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [release]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')) || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download grammar artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-grammars
        path: ustar-parser/src/
    
    - name: Extract version from ustar-parser
      id: version
      run: |
        VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "ustar-parser") | .version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
    
    - name: Create GitHub release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release v${{ steps.version.outputs.version }}
        body: |
          ## USTAR v${{ steps.version.outputs.version }}
          
          STAR format parser library and tools for Rust.
          
          ### What's Included
          - Core parser library published to crates.io as `ustar-parser`
          - Command-line tools published to crates.io as `ustar-tools`
          - Generated grammar files for ASCII, Extended ASCII, and Unicode modes
          - Support for CIF, mmCIF, NMR-STAR, and other STAR format variants
          
          ### Installation
          ```toml
          # Parser library
          [dependencies]
          ustar-parser = "${{ steps.version.outputs.version }}"
          
          # Command-line tools
          cargo install ustar-tools
          ```
          
          ### Documentation
          - [Parser Documentation](https://docs.rs/ustar-parser/${{ steps.version.outputs.version }})
          - [Tools Documentation](https://docs.rs/ustar-tools)
          - [Repository](https://github.com/${{ github.repository }})
        draft: false
        prerelease: false
    
    - name: Upload grammar files to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ustar-parser/src/star_ascii.pest
        asset_name: star_ascii.pest
        asset_content_type: text/plain
    
    - name: Upload extended grammar to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ustar-parser/src/star_extended.pest
        asset_name: star_extended.pest
        asset_content_type: text/plain
    
    - name: Upload unicode grammar to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ustar-parser/src/star_unicode.pest
        asset_name: star_unicode.pest
        asset_content_type: text/plain